<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>‚ûï Th√™m m√≥n m·ªõi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        function updateIngredientIndices() {
            const container = document.getElementById("ingredients");
            Array.from(container.children).forEach((row, i) => {
                row.querySelector('select[name$=".productId"]').name = `ingredients[${i}].productId`;
                row.querySelector('input[name$=".quantity"]').name = `ingredients[${i}].quantity`;
                row.querySelector('select[name$=".unitName"]').name = `ingredients[${i}].unitName`;
            });
        }

        function addIngredientRow() {
            const container = document.getElementById("ingredients");
            const templateRow = document.getElementById("template-row").cloneNode(true);
            templateRow.removeAttribute("id");
            templateRow.classList.remove("hidden");
            container.appendChild(templateRow);
            updateIngredientIndices();
        }

        function removeRow(btn) {
            btn.parentElement.remove();
            updateIngredientIndices();
        }
    </script>
</head>
<body class="bg-gray-100">
<div layout:fragment="content" class="max-w-3xl mx-auto mt-8 bg-white p-6 rounded shadow">

    <h2 class="text-2xl font-bold text-blue-600 mb-6">‚ûï Th√™m m√≥n m·ªõi</h2>

    <form th:action="@{/menu/add}" method="post" th:object="${menuItemRequest}" class="space-y-6">

        <!-- T√™n m√≥n -->
        <div>
            <label class="block font-semibold mb-1">T√™n m√≥n:</label>
            <input type="text" th:field="*{itemName}" placeholder="T√™n m√≥n..." required maxlength="15"
                   class="w-full border px-3 py-2 rounded"/>
            <div th:if="${#fields.hasErrors('itemName')}" th:errors="*{itemName}"
                 class="text-red-600 text-sm mt-1"></div>
        </div>

        <!-- Gi√° ti·ªÅn -->
        <div>
            <label class="block font-semibold mb-1">Gi√° ti·ªÅn (ƒë·ªìng):</label>
            <input type="number" th:field="*{currentPrice}" step="1" min="1000" max="999999999" required
                   class="w-full border px-3 py-2 rounded"
                   oninput="if(this.value.length>9)this.value=this.value.slice(0,9)">
            <div th:if="${#fields.hasErrors('currentPrice')}" th:errors="*{currentPrice}"
                 class="text-red-600 text-sm mt-1"></div>
        </div>

        <!-- Th√†nh ph·∫ßn -->
        <div>
            <h4 class="text-lg font-semibold mb-2">ü•£ Th√†nh ph·∫ßn</h4>
            <div id="ingredients" class="space-y-2">
                <div th:each="ingredient, iterStat : *{ingredients}" class="flex gap-2 mb-2">

                    <!-- Product -->
                    <select th:field="*{ingredients[__${iterStat.index}__].productId}" required
                            class="border px-2 py-1 rounded w-1/3">
                        <option value="" disabled>-- Ch·ªçn th√†nh ph·∫ßn --</option>
                        <option th:each="product : ${products}" th:value="${product.id}" th:text="${product.productName}"
                                th:selected="${product.id == ingredient.productId}"></option>
                    </select>

                    <!-- Quantity -->
                    <div class="flex flex-col w-1/4">
                        <input type="number" th:field="*{ingredients[__${iterStat.index}__].quantity}"
                               placeholder="Kh·ªëi l∆∞·ª£ng" step="1" min="1" max="1000" required
                               pattern="^\d+(\.\d{1,2})?$"
                               title="Nh·∫≠p s·ªë h·ª£p l·ªá, d√πng d·∫•u ch·∫•m cho ph·∫ßn th·∫≠p ph√¢n"
                               class="border px-2 py-1 rounded w-full"/>
                        <div th:if="${#fields.hasErrors('ingredients[' + iterStat.index + '].quantity')}"
                             th:errors="*{ingredients[__${iterStat.index}__].quantity}"
                             class="text-red-600 text-sm mt-1"></div>
                    </div>

                    <!-- Unit -->
                    <select th:field="*{ingredients[__${iterStat.index}__].unitName}" required
                            class="border px-2 py-1 rounded w-1/4">
                        <option value="" disabled>-- Ch·ªçn ƒë∆°n v·ªã --</option>
                        <option th:each="unit : ${units}" th:value="${unit.unitName}" th:text="${unit.unitName}"
                                th:selected="${unit.unitName == ingredient.unitName}"></option>
                    </select>

                    <button type="button" onclick="removeRow(this)" class="text-red-600 hover:underline">X√≥a</button>
                </div>
            </div>

            <button type="button" onclick="addIngredientRow()" class="mt-3 text-sm text-blue-600 hover:underline">+ Th√™m th√†nh ph·∫ßn</button>
        </div>

        <!-- H√†nh ƒë·ªông -->
        <div class="flex justify-end gap-4 pt-4">
            <a th:href="@{/menu}" class="bg-gray-300 hover:bg-gray-400 text-gray-800 px-4 py-2 rounded">‚ùå H·ªßy</a>
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">‚úÖ L∆∞u</button>
        </div>
    </form>

    <!-- Template row ·∫©n -->
    <div id="template-row" class="flex gap-2 mb-2 hidden">
        <select name="ingredients[0].productId" required class="border px-2 py-1 rounded w-1/3">
            <option value="" disabled selected>-- Ch·ªçn th√†nh ph·∫ßn --</option>
            <option th:each="product : ${products}" th:value="${product.id}" th:text="${product.productName}"></option>
        </select>
        <div class="flex flex-col w-1/4">
            <input type="number" name="ingredients[0].quantity" placeholder="Kh·ªëi l∆∞·ª£ng" step="1" min="1"  max="1000" required
                   class="border px-2 py-1 rounded w-full"/>
        </div>
        <select name="ingredients[0].unitName" required class="border px-2 py-1 rounded w-1/4">
            <option value="" disabled selected>-- Ch·ªçn ƒë∆°n v·ªã --</option>
            <option th:each="unit : ${units}" th:value="${unit.unitName}" th:text="${unit.unitName}"></option>
        </select>
        <button type="button" onclick="removeRow(this)" class="text-red-600 hover:underline">X√≥a</button>
    </div>

</div>
</body>
</html>
